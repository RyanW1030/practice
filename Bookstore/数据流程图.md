# 书店管理系统 - 数据流程图

## 一、整体架构数据流

```mermaid
graph TB
    A[用户浏览器] -->|HTTP请求| B[JSP页面]
    B -->|表单提交/链接| C[Servlet控制器]
    C -->|调用业务方法| D[Service服务层]
    D -->|调用数据访问| E[DAO数据访问层]
    E -->|SQL查询| F[(MySQL数据库)]
    F -->|返回结果集| E
    E -->|返回实体对象| D
    D -->|返回业务结果| C
    C -->|设置request/session| G[转发/重定向]
    G -->|渲染页面| B
    B -->|HTML响应| A
```

## 二、用户登录流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant J as login.jsp
    participant S as userServlet
    participant SV as userService
    participant D as userDAO
    participant DB as MySQL

    U->>J: 访问登录页面
    U->>J: 输入用户名密码
    J->>S: POST /userServlet?action=login
    S->>S: WebUtils.param2Bean()<br/>封装UserInfo对象
    S->>SV: userService.login(user)
    SV->>D: userDAO.login(connection, user)
    D->>DB: SELECT * FROM user_info<br/>WHERE username=? AND password=?
    DB-->>D: 返回结果集
    D->>D: baseDAO.retrieve()<br/>自动封装为UserInfo
    D-->>SV: 返回UserInfo对象
    SV-->>S: 返回UserInfo对象
    
    alt 登录成功
        S->>S: session.setAttribute("user", loginUser)
        S->>J: 重定向到首页
    else 登录失败
        S->>S: request.setAttribute("isLogin", false)
        S->>J: 转发回login.jsp
    end
```

## 三、图书浏览流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant P as pageServlet
    participant BS as bookService
    participant BD as bookDAO
    participant DB as MySQL
    participant J as front.jsp

    U->>P: GET /pageServlet?action=List<br/>&categoryId=1&keyword=Java
    P->>P: 获取categoryId和keyword参数
    P->>BS: bookService.List(categoryId, keyword)
    
    alt 有关键词
        BS->>BD: bookDAO.query(connection, keyword)
        BD->>DB: SELECT * FROM book<br/>WHERE author=? OR name LIKE ?<br/>AND stock>=0
    else 有分类ID
        BS->>BD: bookDAO.List(connection, categoryId)
        BD->>DB: SELECT * FROM book<br/>WHERE category_id=?<br/>AND stock>=0
    else 无参数
        BS->>BD: bookDAO.List(connection)
        BD->>DB: SELECT * FROM book<br/>WHERE stock>=0
    end
    
    DB-->>BD: 返回结果集
    BD->>BD: baseDAO.retrieve()<br/>自动封装为Book对象列表
    BD-->>BS: 返回ArrayList<Book>
    
    P->>BS: bookService.recommend(user)
    BS->>BD: bookDAO.recommend(connection, preferences)
    BD->>DB: SELECT * FROM book<br/>WHERE category_id IN(...)<br/>ORDER BY sales DESC LIMIT 5
    DB-->>BD: 返回推荐图书
    BD-->>BS: 返回推荐列表
    BS-->>P: 返回推荐列表
    
    P->>P: request.setAttribute("List", list)<br/>request.setAttribute("Recommend", recommend)
    P->>J: 转发到front.jsp
    J-->>U: 显示图书列表和推荐
```

## 四、购物车添加流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant D as detail.jsp
    participant C as cartServlet
    participant CS as cartitemService
    participant CD as cartitemDAO
    participant DB as MySQL

    U->>D: 在图书详情页点击"加入购物车"
    D->>C: GET /cartServlet?action=add<br/>&bookId=1&count=1&userId=1
    C->>C: WebUtils.param2Bean()<br/>封装CartItem对象
    C->>CS: cartitemService.insert(cartItem)
    CS->>CD: cartitemDAO.insert(connection, cartItem)
    CD->>DB: INSERT INTO cart_item<br/>(user_id, book_id, count)<br/>VALUES (?, ?, ?)
    DB-->>CD: 插入成功
    CD-->>CS: 返回影响行数
    CS-->>C: 返回结果
    
    C->>C: 构建重定向URL<br/>保留categoryId、page、keyword参数
    C->>D: 重定向到图书列表页
    D-->>U: 显示添加成功提示
```

## 五、订单创建流程（事务处理）

```mermaid
sequenceDiagram
    participant U as 用户
    participant C as cart.jsp
    participant O as orderServlet
    participant OS as UserOrderService
    participant OD as UserOrderDAO
    participant OID as orderitemDAO
    participant CD as cartitemDAO
    participant BD as bookDAO
    participant DB as MySQL

    U->>C: 在购物车页面点击"结算"
    C->>O: POST /orderServlet?action=createOrder<br/>&cartItemIds=1,2,3
    O->>O: WebUtils.parseIntArray()<br/>解析购物车ID数组
    O->>OS: userOrderService.createOrder(user, cartitem_ids)
    
    Note over OS,DB: 开启事务 connection.setAutoCommit(false)
    
    OS->>OS: 生成UUID订单号
    OS->>OD: userOrderDAO.insert(connection, user, uuid, 0)
    OD->>DB: INSERT INTO user_order<br/>(order_id, user_id, total_money, status)<br/>VALUES (?, ?, 0, 0)
    DB-->>OD: 订单主表创建成功
    
    loop 遍历每个购物车商品
        OS->>OS: 获取购物车商品和图书信息
        OS->>OID: orderitemDAO.insert(connection, uuid, cartItem, book)
        OID->>DB: INSERT INTO order_item<br/>(order_id, book_id, count, price)
        DB-->>OID: 订单明细插入成功
        
        OS->>OS: 累加订单金额<br/>total_money += price * count
        
        OS->>BD: bookDAO.update(connection, book)
        BD->>DB: UPDATE book SET<br/>stock=stock-?, sales=sales+?<br/>WHERE id=?
        DB-->>BD: 库存和销量更新成功
        
        OS->>CD: cartitemDAO.delete(connection, cartItemId)
        CD->>DB: DELETE FROM cart_item WHERE id=?
        DB-->>CD: 购物车商品删除成功
    end
    
    OS->>OD: userOrderDAO.update(connection, uuid, total_money)
    OD->>DB: UPDATE user_order<br/>SET total_money=?<br/>WHERE order_id=?
    DB-->>OD: 订单总金额更新成功
    
    Note over OS,DB: 提交事务 connection.commit()
    
    OS-->>O: 返回订单ID
    O->>O: request.setAttribute("order_id", order_id)
    O->>O: 调用List()方法
    O->>C: 转发到订单详情页
    C-->>U: 显示订单详情
```

## 六、订单支付流程（事务处理）

```mermaid
sequenceDiagram
    participant U as 用户
    participant O as orderServlet
    participant OS as UserOrderService
    participant OD as UserOrderDAO
    participant UD as userDAO
    participant DB as MySQL

    U->>O: POST /orderServlet?action=payment<br/>&order_id=xxx
    O->>O: 从session获取用户信息
    O->>OS: userOrderService.pay(order_id, user_id)
    
    Note over OS,DB: 开启事务 connection.setAutoCommit(false)
    
    OS->>OD: userOrderDAO.selectById(connection, order_id)
    OD->>DB: SELECT * FROM user_order<br/>WHERE order_id=?
    DB-->>OD: 返回订单信息
    OD-->>OS: 返回UserOrder对象
    
    OS->>UD: userDAO.selectById(connection, user_id)
    UD->>DB: SELECT * FROM user_info<br/>WHERE id=?
    DB-->>UD: 返回用户信息
    UD-->>OS: 返回UserInfo对象
    
    OS->>OS: 检查订单状态<br/>if (status == 1) return 1
    
    OS->>OS: 检查用户余额<br/>if (balance < total_money) return 0
    
    OS->>UD: userDAO.updateBalance(connection, user_id, newBalance)
    UD->>DB: UPDATE user_info<br/>SET balance=balance-?<br/>WHERE id=?
    DB-->>UD: 余额扣除成功
    
    OS->>OD: userOrderDAO.updateStatus(connection, order_id, 1)
    OD->>DB: UPDATE user_order<br/>SET status=1<br/>WHERE order_id=?
    DB-->>OD: 订单状态更新成功
    
    Note over OS,DB: 提交事务 connection.commit()
    
    OS-->>O: 返回支付结果
    O->>UD: userDAO.selectById(connection, user_id)
    UD->>DB: SELECT * FROM user_info WHERE id=?
    DB-->>UD: 返回更新后的用户信息
    UD-->>O: 返回UserInfo对象
    O->>O: session.setAttribute("user", updateUser)
    O->>O: 调用List()方法显示订单详情
    O-->>U: 显示支付成功
```

## 七、订单取消流程（事务处理）

```mermaid
sequenceDiagram
    participant U as 用户
    participant O as orderServlet
    participant OS as UserOrderService
    participant OD as UserOrderDAO
    participant OID as orderitemDAO
    participant CD as cartitemDAO
    participant BD as bookDAO
    participant UD as userDAO
    participant DB as MySQL

    U->>O: POST /orderServlet?action=cancelOrder<br/>&order_id=xxx
    O->>OS: userOrderService.cancelOrder(order_id)
    
    Note over OS,DB: 开启事务 connection.setAutoCommit(false)
    
    OS->>OD: userOrderDAO.selectById(connection, order_id)
    OD->>DB: SELECT * FROM user_order WHERE order_id=?
    DB-->>OD: 返回订单信息
    OD-->>OS: 返回UserOrder对象
    
    OS->>OID: orderitemDAO.List(connection, order_id)
    OID->>DB: SELECT * FROM order_item WHERE order_id=?
    DB-->>OID: 返回订单明细列表
    OID-->>OS: 返回OrderItem列表
    
    loop 遍历每个订单明细
        OS->>OS: 获取book_id和count
        
        OS->>CD: cartitemDAO.selectByUserAndBook(connection, user_id, book_id)
        CD->>DB: SELECT * FROM cart_item<br/>WHERE user_id=? AND book_id=?
        DB-->>CD: 返回购物车项（可能为空）
        CD-->>OS: 返回CartItem或null
        
        alt 购物车中已有该商品
            OS->>CD: cartitemDAO.update(connection, cartItem)
            CD->>DB: UPDATE cart_item<br/>SET count=count+?<br/>WHERE id=?
        else 购物车中没有该商品
            OS->>CD: cartitemDAO.insert(connection, cartItem)
            CD->>DB: INSERT INTO cart_item<br/>(user_id, book_id, count)
        end
        
        OS->>BD: bookDAO.selectById(connection, book_id)
        BD->>DB: SELECT * FROM book WHERE id=?
        DB-->>BD: 返回图书信息
        BD-->>OS: 返回Book对象
        
        OS->>OS: book.sales -= count<br/>if (stock != -1) stock += count
        
        OS->>BD: bookDAO.update(connection, book)
        BD->>DB: UPDATE book<br/>SET sales=?, stock=?<br/>WHERE id=?
        DB-->>BD: 库存和销量恢复成功
    end
    
    alt 订单已支付 (status == 1)
        OS->>UD: userDAO.selectById(connection, user_id)
        UD->>DB: SELECT * FROM user_info WHERE id=?
        DB-->>UD: 返回用户信息
        UD-->>OS: 返回UserInfo对象
        
        OS->>UD: userDAO.updateBalance(connection, user_id, newBalance)
        UD->>DB: UPDATE user_info<br/>SET balance=balance+?<br/>WHERE id=?
        DB-->>UD: 余额退还成功
    end
    
    OS->>OID: orderitemDAO.delete(connection, order_id)
    OID->>DB: DELETE FROM order_item WHERE order_id=?
    DB-->>OID: 订单明细删除成功
    
    OS->>OD: userOrderDAO.delete(connection, order_id)
    OD->>DB: DELETE FROM user_order WHERE order_id=?
    DB-->>OD: 订单删除成功
    
    Note over OS,DB: 提交事务 connection.commit()
    
    OS-->>O: 返回取消结果
    O->>O: 调用orderList()方法
    O-->>U: 显示订单列表
```

## 八、管理员添加图书流程

```mermaid
sequenceDiagram
    participant A as 管理员
    participant J as admin.jsp
    participant AS as adminServlet
    participant BS as bookService
    participant BD as bookDAO
    participant WU as WebUtils
    participant DB as MySQL

    A->>J: 在管理后台填写图书信息<br/>并上传封面图片
    J->>AS: POST /adminServlet?action=addBooks<br/>(multipart/form-data)
    AS->>WU: WebUtils.param2Bean(request, Book.class)
    WU->>WU: 通过反射自动封装Book对象
    WU-->>AS: 返回Book对象
    
    AS->>WU: WebUtils.upload(request)
    WU->>WU: 获取Part对象<br/>生成UUID文件名<br/>保存到/static/img/book/
    WU-->>AS: 返回文件路径
    
    alt 上传了图片
        AS->>AS: book.setImg_path(uploadPath)
    else 未上传图片
        AS->>AS: book.setImg_path("/static/img/book/defaultCover.jpg")
    end
    
    AS->>BS: bookService.add(book)
    BS->>BD: bookDAO.insert(connection, book)
    BD->>DB: INSERT INTO book<br/>(name, author, price, ...)<br/>VALUES (?, ?, ?, ...)
    DB-->>BD: 插入成功
    BD-->>BS: 返回影响行数
    BS-->>AS: 返回结果
    
    AS->>AS: request.setAttribute("add", result)
    AS->>AS: 调用List()方法
    AS->>J: 转发到admin.jsp
    J-->>A: 显示添加结果和图书列表
```

## 九、数据传递路径总结

### 9.1 请求数据流向

```
浏览器请求
    ↓
JSP页面（表单/链接）
    ↓
Servlet控制器（接收request参数）
    ↓
WebUtils工具类（参数封装为Bean）
    ↓
Service服务层（业务逻辑处理）
    ↓
DAO数据访问层（SQL执行）
    ↓
MySQL数据库
```

### 9.2 响应数据流向

```
MySQL数据库（结果集）
    ↓
DAO数据访问层（baseDAO.retrieve()自动封装为Bean）
    ↓
Service服务层（返回业务对象）
    ↓
Servlet控制器（设置request/session属性）
    ↓
JSP页面（EL表达式/JSTL标签渲染）
    ↓
浏览器（HTML响应）
```

### 9.3 数据存储位置

- **request域**：页面间传递的临时数据（转发时有效）
- **session域**：用户会话数据（登录用户信息、购物车状态等）
- **数据库**：持久化数据（用户、图书、订单等）

### 9.4 关键数据传递点

1. **参数封装**：`WebUtils.param2Bean()` - request参数 → JavaBean
2. **结果集映射**：`baseDAO.retrieve()` - ResultSet → JavaBean列表
3. **数据传递**：request.setAttribute() / session.setAttribute()
4. **页面渲染**：JSP EL表达式 ${} 获取数据

---

## 十、事务处理流程图

```mermaid
graph TB
    A[开始业务操作] --> B[获取数据库连接]
    B --> C[connection.setAutoCommit false]
    C --> D{执行多个数据库操作}
    D --> E[操作1: 插入/更新/删除]
    E --> F[操作2: 插入/更新/删除]
    F --> G[操作3: 插入/更新/删除]
    G --> H{所有操作是否成功?}
    H -->|是| I[connection.commit 提交事务]
    H -->|否| J[connection.rollback 回滚事务]
    I --> K[关闭连接]
    J --> K
    K --> L[返回结果]
    
    style I fill:#90EE90
    style J fill:#FFB6C1
```

---

## 总结

本项目的数据传递遵循经典的MVC三层架构模式，通过以下机制实现高效的数据流转：

1. **反射机制**：自动参数封装和结果集映射，减少重复代码
2. **事务管理**：关键业务操作使用事务保证数据一致性
3. **统一入口**：baseServlet通过action参数统一分发请求
4. **通用DAO**：baseDAO通过泛型和反射实现通用数据访问

整个系统的数据流清晰、职责分明，便于维护和扩展。

