# 书店管理系统 - 项目分析报告

## 一、项目概述

这是一个基于Java Web技术栈开发的书店管理系统，采用经典的MVC（Model-View-Controller）架构模式，实现了完整的在线书店业务功能。

### 技术栈
- **后端框架**：Java Servlet + JSP
- **数据库**：MySQL
- **架构模式**：MVC三层架构（Controller-Service-DAO）
- **前端技术**：JSP + Bootstrap + CSS/JavaScript

---

## 二、主要功能模块

### 2.1 用户功能模块
1. **用户注册与登录**
   - 用户注册（用户名唯一性验证）
   - 用户登录（用户名密码验证）
   - 用户登出

2. **个人信息管理**
   - 查看个人资料
   - 修改个人信息（密码、邮箱、电话、地址、头像）
   - 设置图书偏好（用于个性化推荐）

3. **图书浏览与搜索**
   - 图书列表展示（支持分类筛选）
   - 图书详情查看
   - 关键词搜索（支持书名和作者搜索）
   - 个性化推荐（基于用户偏好和销量）

4. **购物车管理**
   - 添加商品到购物车
   - 查看购物车
   - 修改购物车商品数量
   - 批量删除购物车商品

5. **订单管理**
   - 创建订单（从购物车生成）
   - 订单支付（余额支付）
   - 查看订单列表
   - 查看订单详情
   - 取消订单（自动恢复库存和余额）
   - 确认收货

### 2.2 管理员功能模块
1. **图书管理**
   - 添加图书（支持图片上传）
   - 修改图书信息
   - 删除图书（软删除，放入回收站）
   - 恢复图书（从回收站恢复）
   - 彻底删除图书（物理删除）
   - 查看回收站

2. **用户管理**
   - 查看所有用户列表
   - 用户余额充值
   - 重置用户密码（默认密码：12345678）
   - 删除用户（级联删除相关数据）

3. **订单管理**
   - 查看所有订单
   - 订单发货（更新订单状态）

---

## 三、核心架构设计

### 3.1 分层架构

```
┌─────────────────────────────────────┐
│         View层 (JSP页面)              │
│  - front.jsp (首页)                  │
│  - user/*.jsp (用户相关页面)          │
│  - admin/admin.jsp (管理后台)         │
└─────────────────────────────────────┘
              ↓ ↑
┌─────────────────────────────────────┐
│      Controller层 (Servlet)          │
│  - baseServlet (基础Servlet)         │
│  - userServlet (用户控制器)           │
│  - pageServlet (页面控制器)           │
│  - cartServlet (购物车控制器)         │
│  - orderServlet (订单控制器)          │
│  - adminServlet (管理员控制器)        │
└─────────────────────────────────────┘
              ↓ ↑
┌─────────────────────────────────────┐
│      Service层 (业务逻辑层)           │
│  - userService (用户服务)            │
│  - bookService (图书服务)             │
│  - cartitemService (购物车服务)       │
│  - UserOrderService (订单服务)        │
│  - adminService (管理员服务)          │
└─────────────────────────────────────┘
              ↓ ↑
┌─────────────────────────────────────┐
│      DAO层 (数据访问层)               │
│  - baseDAO (通用DAO基类)              │
│  - userDAO (用户数据访问)             │
│  - bookDAO (图书数据访问)             │
│  - cartitemDAO (购物车数据访问)        │
│  - UserOrderDAO (订单数据访问)         │
└─────────────────────────────────────┘
              ↓ ↑
┌─────────────────────────────────────┐
│         Database (MySQL)             │
└─────────────────────────────────────┘
```

### 3.2 核心设计模式

#### 1. 反射机制 - baseServlet
```java
// 通过action参数动态调用对应方法
String action = request.getParameter("action");
Method method = this.getClass().getDeclaredMethod(action, 
    HttpServletRequest.class, HttpServletResponse.class);
method.invoke(this, request, response);
```
**优势**：减少重复代码，统一请求处理入口

#### 2. 泛型 + 反射 - baseDAO
```java
// 通用数据访问基类，通过反射自动封装ResultSet到Bean
public abstract class baseDAO<T> {
    // 自动将查询结果映射到实体对象
    public ArrayList<T> retrieve(Connection connection, String sql, Object... param)
}
```
**优势**：避免重复的JDBC代码，提高开发效率

#### 3. 参数自动封装 - WebUtils
```java
// 自动将request参数封装到JavaBean
public static <T> T param2Bean(HttpServletRequest request, Class<T> clazz)
```
**优势**：简化参数获取和对象创建过程

---

## 四、主要类和方法详解

### 4.1 Controller层（控制器）

#### baseServlet（基础Servlet）
- **作用**：所有Servlet的基类，实现统一请求分发
- **核心方法**：
  - `doGet()` / `doPost()`：根据`action`参数通过反射调用对应方法

#### userServlet（用户控制器）
- **主要方法**：
  - `login()`：用户登录验证
  - `register()`：用户注册
  - `profile()`：查看/编辑个人资料
  - `update()`：更新用户信息
  - `logout()`：用户登出

#### pageServlet（页面控制器）
- **主要方法**：
  - `List()`：图书列表展示（支持分类和关键词筛选）
  - `Detail()`：图书详情展示

#### cartServlet（购物车控制器）
- **主要方法**：
  - `Map()`：获取购物车商品映射（CartItem -> Book）
  - `add()`：添加商品到购物车
  - `update()`：更新购物车商品数量
  - `delete()`：删除购物车商品

#### orderServlet（订单控制器）
- **主要方法**：
  - `createOrder()`：创建订单
  - `List()`：查看订单详情
  - `orderList()`：查看订单列表
  - `payment()`：订单支付
  - `cancelOrder()`：取消订单
  - `confirm()`：确认收货

#### adminServlet（管理员控制器）
- **主要方法**：
  - `login()`：管理员登录
  - `List()`：管理后台首页数据展示
  - `addBooks()`：添加图书
  - `updateBooks()`：更新图书信息
  - `deleteBooks()`：软删除图书
  - `recycleBooks()`：恢复图书
  - `eraseBooks()`：彻底删除图书
  - `shipOrder()`：订单发货
  - `recharge()`：用户充值
  - `resetPwd()`：重置用户密码
  - `deleteUser()`：删除用户

### 4.2 Service层（业务逻辑层）

#### userServiceImpl（用户服务实现）
- **主要方法**：
  - `login()`：用户登录业务逻辑
  - `register()`：用户注册（包含用户名重复检查）
  - `update()`：更新用户信息
  - `recharge()`：用户余额充值
  - `delete()`：删除用户（事务处理，级联删除相关数据）

#### bookServiceImpl（图书服务实现）
- **主要方法**：
  - `List()`：获取图书列表（支持分类和关键词查询）
  - `recommend()`：图书推荐（基于用户偏好或销量）
  - `selectById()`：根据ID查询图书
  - `add()`：添加图书
  - `update()`：更新图书信息
  - `softDelete()`：软删除图书（stock=-1）
  - `recycle()`：恢复图书（stock=0）
  - `delete()`：物理删除图书（事务处理）

#### UserOrderServiceImpl（订单服务实现）
- **主要方法**：
  - `createOrder()`：创建订单（事务处理）
    - 创建订单主表记录
    - 创建订单明细
    - 更新图书库存和销量
    - 删除购物车商品
    - 计算并更新订单总金额
  - `pay()`：订单支付（事务处理）
    - 检查用户余额
    - 扣除用户余额
    - 更新订单状态为已支付
  - `cancelOrder()`：取消订单（事务处理）
    - 恢复图书库存
    - 恢复用户余额（如果已支付）
    - 将商品退回购物车
    - 删除订单记录
  - `updateStatus()`：更新订单状态
  - `List()`：获取订单列表

### 4.3 DAO层（数据访问层）

#### baseDAO（通用DAO基类）
- **核心方法**：
  - `retrieve()`：通用查询方法（通过反射自动封装结果集）
  - `cud()`：通用增删改方法（Create, Update, Delete）
  - `getField()`：获取单个字段值

#### userDAOImpl（用户DAO实现）
- **主要方法**：
  - `login()`：用户登录查询
  - `register()`：用户注册插入
  - `isRegister()`：检查用户名是否已存在
  - `update()`：更新用户信息
  - `selectById()`：根据ID查询用户
  - `updateBalance()`：更新用户余额
  - `resetPassword()`：重置密码

#### bookDAOImpl（图书DAO实现）
- **主要方法**：
  - `List()`：查询图书列表
  - `query()`：关键词搜索
  - `recommend()`：推荐图书查询
  - `selectById()`：根据ID查询
  - `insert()`：插入新图书
  - `update()`：更新图书信息
  - `softDelete()`：软删除（更新stock=-1）
  - `recycle()`：恢复图书（更新stock=0）
  - `delete()`：物理删除

### 4.4 工具类

#### JDBCUtils（数据库工具类）
- **主要方法**：
  - `getConnection()`：获取数据库连接（从配置文件读取）
  - `close()`：关闭数据库资源（重载方法，支持不同参数组合）

#### WebUtils（Web工具类）
- **主要方法**：
  - `param2Bean()`：将request参数自动封装到JavaBean
  - `parseInts()`：字符串数组转整数数组
  - `parseIntArray()`：逗号分隔字符串转整数数组
  - `makeUUID()`：生成UUID
  - `upload()`：文件上传处理
  - `getValue()`：从request中获取值（优先Attribute，其次Parameter）

#### CharsetFilter（字符编码过滤器）
- **作用**：统一设置请求和响应的字符编码为UTF-8
- **过滤规则**：排除静态资源（CSS、JS、图片等）

---

## 五、数据传递流程

### 5.1 用户登录流程

```
1. 用户访问 login.jsp
   ↓
2. 提交登录表单 → userServlet?action=login
   ↓
3. userServlet.login()
   - 使用WebUtils.param2Bean()封装UserInfo对象
   ↓
4. userService.login()
   - 调用userDAO.login()
   ↓
5. userDAO.login()
   - 执行SQL查询：SELECT * FROM user_info WHERE username=? AND password=?
   - 返回UserInfo对象
   ↓
6. 验证结果
   - 成功：将UserInfo存入Session，重定向到首页
   - 失败：返回登录页面，显示错误信息
```

### 5.2 图书浏览流程

```
1. 用户访问首页 → pageServlet?action=List
   ↓
2. pageServlet.List()
   - 获取categoryId和keyword参数
   ↓
3. bookService.List()
   - 根据参数调用bookDAO查询
   ↓
4. bookDAO.List() / bookDAO.query()
   - 执行SQL查询
   - 通过baseDAO.retrieve()自动封装结果
   ↓
5. 返回Book列表
   ↓
6. 同时获取推荐图书（bookService.recommend()）
   ↓
7. 将数据存入request域
   ↓
8. 转发到front.jsp显示
```

### 5.3 购物车添加流程

```
1. 用户在图书详情页点击"加入购物车"
   → cartServlet?action=add&bookId=xxx&count=1
   ↓
2. cartServlet.add()
   - WebUtils.param2Bean()封装CartItem对象
   ↓
3. cartitemService.insert()
   - 调用cartitemDAO.insert()
   ↓
4. 插入数据库
   ↓
5. 重定向回图书列表页（保留分类和页码参数）
```

### 5.4 订单创建流程（事务处理）

```
1. 用户在购物车页面点击"结算"
   → orderServlet?action=createOrder&cartItemIds=1,2,3
   ↓
2. orderServlet.createOrder()
   ↓
3. UserOrderService.createOrder() [开启事务]
   ├─ 创建订单主表（初始金额为0）
   ├─ 遍历购物车商品：
   │  ├─ 创建订单明细
   │  ├─ 累加订单金额
   │  ├─ 更新图书库存（stock -= count）
   │  ├─ 更新图书销量（sales += count）
   │  └─ 删除购物车商品
   ├─ 更新订单总金额
   └─ 提交事务
   ↓
4. 如果任何步骤失败 → 回滚事务
   ↓
5. 返回订单ID，跳转到订单详情页
```

### 5.5 订单支付流程（事务处理）

```
1. 用户在订单详情页点击"支付"
   → orderServlet?action=payment&order_id=xxx
   ↓
2. orderServlet.payment()
   ↓
3. UserOrderService.pay() [开启事务]
   ├─ 查询订单信息
   ├─ 查询用户信息
   ├─ 检查订单状态（是否已支付）
   ├─ 检查用户余额是否充足
   ├─ 扣除用户余额
   └─ 更新订单状态为已支付(1)
   ↓
4. 提交事务 / 失败则回滚
   ↓
5. 更新Session中的用户信息
   ↓
6. 跳转到订单详情页
```

### 5.6 订单取消流程（事务处理）

```
1. 用户点击"取消订单"
   → orderServlet?action=cancelOrder&order_id=xxx
   ↓
2. UserOrderService.cancelOrder() [开启事务]
   ├─ 查询订单信息
   ├─ 遍历订单明细：
   │  ├─ 恢复图书库存（stock += count）
   │  ├─ 减少图书销量（sales -= count）
   │  └─ 将商品退回购物车
   ├─ 如果订单已支付，退还用户余额
   ├─ 删除订单明细
   └─ 删除订单主表
   ↓
3. 提交事务 / 失败则回滚
   ↓
4. 跳转到订单列表页
```

---

## 六、数据库设计要点

### 6.1 核心表结构

1. **user_info（用户表）**
   - id, username, password, email, balance, phone, address, avatar

2. **book（图书表）**
   - id, name, author, price, sales, stock, intro, publisher, isbn, img_path, category_id
   - **注意**：stock=-1表示已下架（软删除）

3. **category（分类表）**
   - id, name

4. **cart_item（购物车表）**
   - id, user_id, book_id, count

5. **user_order（订单主表）**
   - order_id (UUID), user_id, total_money, status, create_time, receiver_address, receiver_phone
   - **status**：0-未支付，1-已支付，2-已发货，3-已收货

6. **order_item（订单明细表）**
   - id, order_id, book_id, count, price

7. **user_preference（用户偏好表）**
   - user_id, category_id

8. **admin（管理员表）**
   - id, username, password

### 6.2 事务处理场景

1. **订单创建**：订单主表 + 订单明细 + 库存更新 + 购物车删除
2. **订单支付**：用户余额扣除 + 订单状态更新
3. **订单取消**：库存恢复 + 余额退还 + 订单删除
4. **用户删除**：用户 + 订单 + 订单明细 + 购物车 + 偏好（级联删除）

---

## 七、关键技术点

### 7.1 反射机制的应用
- **baseServlet**：动态方法调用
- **baseDAO**：自动结果集映射
- **WebUtils**：自动参数封装

### 7.2 事务管理
- 使用`Connection.setAutoCommit(false)`手动管理事务
- 关键业务操作（订单创建、支付、取消）都使用事务保证数据一致性

### 7.3 软删除机制
- 图书删除使用软删除（stock=-1），保留数据便于恢复
- 回收站功能支持恢复和彻底删除

### 7.4 文件上传
- 使用Servlet 3.0的`@MultipartConfig`注解
- 文件重命名使用UUID防止重名
- 文件保存到web应用的静态资源目录

### 7.5 字符编码处理
- 使用Filter统一处理字符编码
- 排除静态资源，避免影响性能

---

## 八、项目特点总结

### 优点
1. **架构清晰**：严格遵循MVC三层架构，职责分明
2. **代码复用**：通过反射和泛型实现通用DAO和Servlet基类
3. **事务安全**：关键业务操作都使用事务保证数据一致性
4. **用户体验**：支持个性化推荐、购物车、订单管理等完整功能

### 可改进点
1. **连接池**：当前每次操作都创建新连接，可引入连接池提高性能
2. **异常处理**：部分异常处理可以更加细化
3. **参数验证**：缺少输入参数的合法性验证
4. **安全性**：密码未加密存储，可引入加密机制

---

## 九、总结

本项目是一个功能完整的书店管理系统，采用了经典的Java Web技术栈和MVC架构模式。通过反射机制和泛型设计，实现了代码的高度复用。事务管理确保了关键业务操作的数据一致性。整体代码结构清晰，易于维护和扩展。

